:local ApiTele "7853546086:AAFj4PQIJ97HlAC_DSsnFzcyDL3uInM4JEo";
:local ChatId "5680485003";
:local Nama $user;
:local Ip $address;
:local Waktu [/system clock get time];
:local Tanggal [/system clock get date];

# Debugging: Log event logout
:log info "Logout detected: User - $Nama, IP - $Ip"

# Ambil informasi device dari DHCP lease
:local DeviceName "";
:foreach i in=[/ip dhcp-server lease find where address=$Ip] do={
    :set DeviceName [/ip dhcp-server lease get $i host-name];
}

# Jika device tidak ditemukan di DHCP lease, gunakan default
:if ($DeviceName = "") do={
    :set DeviceName "Unknown Device";
}

# Ambil profile user dari Hotspot Users
:local Profile "Unknown Profile";
:local UserProfile "";
:foreach u in=[/ip hotspot user find where name=$Nama] do={
    :set UserProfile [/ip hotspot user get $u profile];
}

# Jika profile ditemukan, gunakan nilai yang didapat
:if ($UserProfile != "") do={
    :set Profile $UserProfile;
}

# Ambil durasi koneksi (uptime) user dari Hotspot Active
:local Uptime "Unknown";
:foreach a in=[/ip hotspot active find where user=$Nama] do={
    :set Uptime [/ip hotspot active get $a uptime];
}

# Cek apakah logout karena timeout
:local LogoutReason "Manual Logout";
:foreach s in=[/ip hotspot user find where name=$Nama] do={
    :local SessionTime [/ip hotspot user get $s session-time-left];
    :if ($SessionTime = "0s") do={
        :set LogoutReason "Session Timeout ‚è≥";
    }
}

# Susun pesan logout yang menarik
:local Pesan "üö™ *Logout Detected* ‚ùå%0A"
:local Pesan ($Pesan . "üë§ *User*: $Nama%0A")
:local Pesan ($Pesan . "üìú *Profile*: $Profile%0A")
:local Pesan ($Pesan . "üåê *IP Address*: $Ip%0A")
:local Pesan ($Pesan . "üíª *Device*: $DeviceName%0A")
:local Pesan ($Pesan . "‚è≥ *Uptime*: $Uptime%0A")
:local Pesan ($Pesan . "üïí *Logout Time*: $Waktu - $Tanggal%0A")
:local Pesan ($Pesan . "üîç *Reason*: $LogoutReason");

# Debugging: Log pesan sebelum dikirim
:log info "Sending Telegram Logout Message: $Pesan"

# Kirim pesan ke Telegram
/tool fetch url=("https://api.telegram.org/bot" . $ApiTele . "/sendMessage?chat_id=" . $ChatId . "&text=" . $Pesan . "&parse_mode=Markdown") mode=http keep-result=no

